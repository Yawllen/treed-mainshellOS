# ============================
#  TreeD CORE PRINT MACROS
# ============================

[gcode_macro START_PRINT]
description: "TreeD: старт печати без сброса скорости/потока"
# Ожидаем вызов из слайсера вида:
# START_PRINT EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single]
gcode:
  # --- Параметры из слайсера ---
  {% set BED_TEMP = params.BED_TEMP|default(0)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(0)|float %}

  {% if BED_TEMP < 0 %}
    {% set BED_TEMP = 0.0 %}
  {% endif %}
  {% if EXTRUDER_TEMP < 0 %}
    {% set EXTRUDER_TEMP = 0.0 %}
  {% endif %}

  # --- Лимиты осей (для безопасных перемещений) ---
  {% set x_min = printer.toolhead.axis_minimum.x|default(0.0)|float %}
  {% set y_min = printer.toolhead.axis_minimum.y|default(0.0)|float %}
  {% set z_min = printer.toolhead.axis_minimum.z|default(0.0)|float %}
  {% set x_max = printer.toolhead.axis_maximum.x|float %}
  {% set y_max = printer.toolhead.axis_maximum.y|float %}
  {% set z_max = printer.toolhead.axis_maximum.z|float %}

  # Безопасный Z для перелётов
  {% set safe_z = 10.0 %}
  {% if safe_z > z_max - 1.0 %}
    {% set safe_z = z_max - 1.0 %}
  {% endif %}
  {% if safe_z < z_min + 0.5 %}
    {% set safe_z = z_min + 0.5 %}
  {% endif %}

  # Позиции для прайм-линии (отталкиваемся от минимума и не упираемся в максимум)
  {% set prime_y = y_min + 5.0 %}
  {% if prime_y > y_max - 5.0 %}
    {% set prime_y = (y_min + y_max) / 2.0 %}
  {% endif %}

  {% set prime_x_start = x_min + 20.0 %}
  {% if prime_x_start > x_max - 30.0 %}
    {% set prime_x_start = x_min + (x_max - x_min) * 0.2 %}
  {% endif %}

  {% set prime_x_end = x_max - 20.0 %}
  {% if prime_x_end <= prime_x_start + 10.0 %}
    {% set prime_x_end = prime_x_start + 10.0 %}
  {% endif %}

  {% set prime_len = prime_x_end - prime_x_start %}
  {% if prime_len < 10.0 %}
    {% set prime_len = 10.0 %}
  {% endif %}

  {% set prime_x_mid = prime_x_start + prime_len * 0.6 %}
  {% if prime_x_mid > prime_x_end %}
    {% set prime_x_mid = (prime_x_start + prime_x_end) / 2.0 %}
  {% endif %}

  {% set wipe_x = prime_x_end - 5.0 %}
  {% if wipe_x < prime_x_start %}
    {% set wipe_x = prime_x_end %}
  {% endif %}

  # --- Базовые режимы G-кода (НЕ трогаем множители скорости/потока) ---
  G21                       ; миллиметры
  G90                       ; абсолютные координаты XYZ
  M83                       ; относительная подача экструдера
  G92 E0                    ; обнуляем счётчик экструдера

  # --- Нагрев стола (пока выключен: нет термистора/стола) ---
  # Если подключим стол и включим bed_heater_ac_ssr.cfg, раскомментируем:
  # {% if BED_TEMP > 0 %}
  #   M140 S{BED_TEMP}        ; начать греть стол, без ожидания
  # {% endif %}

  # --- Предпрогрев хотэнда: всегда до 140°C, если вообще есть целевая температура ---
  {% if EXTRUDER_TEMP > 0 %}
    M104 S140               ; фиксированный предпрогрев до 140°C
  {% endif %}

  # --- Хоуминг ---
  G28                       ; хоумим все оси

  # --- Безопасный лифт и выезд в зону прайма (с учётом лимитов) ---
  G1 Z{safe_z:.3f} F1200
  G1 X{prime_x_start:.3f} Y{prime_y:.3f} F6000

  # --- Догрев до рабочих температур с ожиданием ---
  # Стол пока не ждём.
  # {% if BED_TEMP > 0 %}
  #   M190 S{BED_TEMP}        ; ждать стол
  # {% endif %}
  {% if EXTRUDER_TEMP > 0 %}
    M109 S{EXTRUDER_TEMP}   ; ждать сопло до рабочей температуры
  {% endif %}

  # --- Прайм-линия в стиле Bambu, но с учётом наших лимитов ---
  G92 E0
  G1 X{prime_x_start:.3f} Y{prime_y:.3f} Z0.4 F300        ; позиция старта линии
  G1 X{prime_x_mid:.3f}   Y{prime_y:.3f} E30 F400        ; тянем линию, выдавливая пластик
  G1 Z0.6 F120                                      ; чуть приподняться
  G1 X{wipe_x:.3f} Y{prime_y:.3f} F3000             ; быстрый сдвиг "протереть" сопло
  G92 E0                                            ; обнулить экструдер перед моделью

  # --- Хуки под будущее (KAMP, конвейер и т.п.) ---
  # Здесь позже появятся:
  #  - загрузка / обновление bed mesh
  #  - вызов KAMP
  #  - управление конвейером
  #  - подсветка / камера / логирование

  RESPOND PREFIX="treed" MSG="START_PRINT done: bed={BED_TEMP} hotend={EXTRUDER_TEMP}"


# ============================
#  PAUSE/RESUME/CANCEL
# ============================

[gcode_macro CANCEL_PRINT]
description: "TreeD: отмена печати (пока дефолтный Klipper)"
rename_existing: CANCEL_PRINT_BASE
gcode:
  CANCEL_PRINT_BASE

[gcode_macro PAUSE]
description: "TreeD: пауза печати (пока дефолтная логика)"
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE

[gcode_macro RESUME]
description: "TreeD: продолжение печати (пока дефолтная логика)"
rename_existing: RESUME_BASE
gcode:
  RESUME_BASE
